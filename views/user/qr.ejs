<!DOCTYPE html>
<html lang="en">
<head>
    <%- include('./parts/head.ejs');%>
</head>
<body>
    <h1>Create New Qr Codes</h1>
    <%- include('./parts/sideNav.ejs');%>
      
    <div class="container">
        <div>
            <h4>Destination</h4>
            <div class="mb-3">
                <input required type="url" name="fullUrl" id="fullUrl"  placeholder="url" class="form-control">
            </div>
            <h4>Title</h4>
            <div class="mb-3">
                <input required type="text" name="title" id="titleUrl"  placeholder="title" class="form-control">
            </div>
            <h4>Short Link</h4>
            <div class="mb-3 d-flex justify-content-around">
                <input type="text" name="shortUrl"  value="127.0.0.1" class="form-control" disabled>
                <h3 style="padding-left: 10px; padding-right: 10px;">/</h3>
                <input type="text" name="shortUrl" id="suffixUrl"  placeholder="shorturl (optional)" class="form-control">
            </div>
            <button type="button" onclick="promptRecommendation(this)" class="btn btn-primary">Prompt</button>
            <button type="button" onclick="submitForm(this)" class="btn btn-primary">Submit</button>
        </div>

        <% for (const key in allUrl) { %>
            <% const data = allUrl[key] %>
        <div class="card mt-4">
            <div class="card-body" >
                <div class="mb-3">
                    <div class="row g-0">
                      <div class="col-md-2">
                        <!-- <div id="qr_<%= key%>" class="ps-4" short="<%= data.short%>"></div> -->
                        <canvas id="qr_<%= key%>" class="ps-1 mt-3" short="<%= data.short%>"></canvas>
                      </div>
                      <div class="col col-md-10">
                        <div class="d-flex flex-row-reverse">
                            <button type="button" onclick="deleteQR(this)" class="btn btn-danger"><i class="fa-solid fa-trash-can pe-2"></i>Delete</button>
                            <button type="button" onclick="editQR(this)" class="btn btn-success mx-2"><i class="fa-solid fa-pen-to-square pe-2"></i>Edit</button>
                            <button type="button" onclick="downloadQR(this)" class="btn btn-secondary" value="qr_<%= key%>" short="<%= data.short%>"><i class="fa-solid fa-download pe-2"></i>Download</button>
                        </div>
                        <div class="text-left">
                          <h4 class="card-title">Card title</h4>
                          <p class="card-text">This is a wider card with supporting text below as a natural lead-in to additional content. This content is a little bit longer.</p>
                          <p class="card-text"><small class="text-body-secondary">Last updated 3 mins ago</small></p>
                        </div>
                      </div>
                    </div>
                  </div>
            </div>
        </div>
        <% } %>

        <table>
            <thead>
                <tr>
                    <th>Full Url</th>
                    <th>ShortUrl</th>
                    <th>Clicks</th>
                    <th>QR</th>
                </tr>
            </thead>
            <tbody>
                <% for (const key in allUrl) { %>
                    <% const data = allUrl[key] %>
                    <tr>
                        <td><%= data.full %></td>
                        <td><%= data.short %></td>
                        <td><%= data.clicks %></td>
                        <td id="qr_<%= key%>"></td>
                        <script>
                            if("<%= data.type %>" == 'qr'){
                                var qrcode = new QRious({
                                    element: document.getElementById("qr_<%= key%>"),
                                    value: "http://127.0.0.1/<%= data.short%>",
                                    padding:25,
                                    size:200
                                })
                            }
                        </script>
                    </tr>
                <% } %>
            </tbody>
        </table>
      <script>
            function promptRecommendation(e){

            }
            function downloadQR(e) {  
                var link = document.createElement('a');
                var short = e.getAttribute('short')
                var target = document.getElementById(e.value)

                link.download = 'qr-'+short+'.png';
                link.href = target.toDataURL()
                link.click();
            }
            function editQR(e) {  

            }
            function deleteQR(e) {  

            }
            function submitForm(e) {
                // try {
                const full = document.querySelector('#fullUrl').value
                const title = document.querySelector('#titleUrl').value
                const short = document.querySelector('#suffixUrl').value
                if (!full) {
                    alert('Url must be filled !')
                    return
                }
                const data = {
                    full,
                    short,
                    title,
                    clicks: 0,
                    type: 'qr'
                }
                console.log(data);
                    fetch('/api/qrcode', {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify(data),
                    }).then(async (response) => {
                        if (response.ok) {
                            window.location.href = "/qr";
                        }
                        else if(response.status){
                            Swal.fire({
                            icon: "error",
                            title: "Ooops....",
                            text: "This Short URL is Already Taken!",
                            });
                        }
                        else{
                        }
                    }).catch((error) => {
                        alert('WARNING!')
                        console.log(error);
                    });
            }
        </script>
    </div>
</body>
</html>